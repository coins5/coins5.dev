---
import BaseLayout from "@/layouts/BaseLayout.astro";
import dayjs from "dayjs";

import relativeTime from "dayjs/plugin/relativeTime";
import type { BlogSchema } from "@/schemas/blog";
import NextPost from "@/components/NextPost.astro";
import { getEntry } from "astro:content";
import { Image } from "astro:assets";

dayjs.extend(relativeTime);

const { entry } = Astro.props;
const { data } = entry;
const post = data as BlogSchema;

const dayDate = dayjs(post.pubDate);

const nextPost = post.nextPost
  ? await getEntry("blog", post.nextPost.id)
  : null;

const author = await getEntry("author", post.author.id);

// Importa todas las im√°genes en assets
const allImages = import.meta.glob(
  "@/assets/images/posts_cover/*.{jpg,png,webp}",
  {
    eager: true,
  }
) as Record<string, ImageMetadata>;

// Intenta resolver la imagen como importada
const resolvedImage = Object.entries(allImages).find(([path]) =>
  path.endsWith(post.image.url)
)?.[1];
---

<BaseLayout pageTitle={post.title} blogPostSeo={post}>
  <div class="prose">
    <div class="flex justify-center"></div>
    <div class="w-full">
      {
        resolvedImage ? (
          <Image
            src={resolvedImage}
            alt={post.image.alt}
            height={600}
            class="rounded-box"
          />
        ) : (
          // <div>
          //   <div>{post.image.url}</div>
          //   <hr />
          //   <div>{JSON.stringify(allImages)}</div>
          //   <hr />
          //   <div>{JSON.stringify(Object.entries(allImages))}</div>
          //   <hr />
          //   <div />
          //   <div>
          //     {JSON.stringify(
          //       Object.entries(allImages).find(([path]) =>
          //         path.endsWith(post.image.url)
          //       )?.[1]
          //     )}
          //   </div>
          // </div>
          <img
            src={post.image.url}
            alt={post.image.alt}
            height="600"
            loading="lazy"
            class="rounded-box"
          />
        )
      }
    </div>

    <h1>
      {post.title}
    </h1>
    <p>
      Written by: {author!.data.name}
      <br />
      <span class="text-sm">
        Posted on {dayDate.format("DD MMM YYYY")} - {dayDate.fromNow()}
      </span>

      <br />
      {
        post.tags.map((tag: string) => (
          <a
            class="badge badge-soft badge-primary no-underline mr-2"
            href={`/tags/${tag}`}
          >
            {tag}
          </a>
        ))
      }
    </p>

    <p><em>{post.description}</em></p>

    <br />

    <slot />

    {nextPost ? <NextPost post={nextPost} /> : null}
  </div>

  <script is:inline src="/src/scripts/copy-code.ts"></script>
  <script>
    import { enableImageZoom } from "@/scripts/zoom.ts";
    enableImageZoom();
  </script>
</BaseLayout>
